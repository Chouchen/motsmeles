<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>mots mélés generator</title>
    <style>
        .inputGrid { width: 10px; height: 10px; float:left;}
        .clearboth {
            clear: both;
        }
    </style>
</head>
<body>
<h3>Current mode : <span id="currentMode">nothing</span></h3>
<aside id="generator-options">
    <label for="grid-width"><input type="number" id="grid-width" min="1" max="20" step="1" name="grid-width" value="1"/></label>
    <label for="grid-height"><input type="number" id="grid-height" min="1" max="20" step="1" name="grid-height" value="1"/></label>
</aside>
<section id="generator-grid"></section>
</body>
<script>
    var grid = [];
    var width = 1;
    var height= 1;
    var current = { word : '', start: [], end: [] };
    //        left = 37
    //        up = 38
    //        right = 39
    //        down = 40
    var sens;
    var senses = [37,38,39,40];
    var isChoosingSens = false;
    var currentModeText = document.getElementById('currentMode');
    var isTypingWord = function() { return !isChoosingSens && sens !== undefined; };
    var isNavigating = function() { return !isChoosingSens && sens === undefined; };
    var inputGrid = document.getElementById('generator-grid');

    var modifyGridSize = function modifyGridSize() {
        var currentWidth = width;//grid[0] ? grid[0].length : 0;
        var currentHeight = height;//grid.length;
        console.log('grid size is ' + currentWidth + ' x ' + currentHeight);
        var iHtml = '';
        for(var i = 0,l = currentHeight; i <l ; i++) {
            for (var j = 0, m = currentWidth; j<m; j++) {
                iHtml += '<input type="text" class="inputGrid" data-x="'+j+'" data-y="'+i+'" maxlength="1"/>';
            }
            iHtml += '<div class="clearboth"></div>';
        }
        inputGrid.innerHTML = iHtml;
        dynamicEvents();
    };
    document.getElementById('grid-width').addEventListener("change", function(evt){
        width = evt.currentTarget.value;
        modifyGridSize();
    }, false);
    document.getElementById('grid-height').addEventListener("change", function(evt){
        height = evt.currentTarget.value;
        modifyGridSize();
    }, false);

    var validWord = function validWord() {
        console.log('todo validword');
    };

    var goToNextCase = function goToNextCase() {
        console.log('todo gotonext');
    };

    /*var gridFocus = function gridFocus(evt) {
        if(sens == undefined && !isChoosingSens) {
            chooseSens();
        }
    };*/

    var gridKeydown = function gridKeydown(evt) {
        var typedKey = evt.keyCode;
//        left = 37
//        up = 38
//        right = 39
//        down = 40
        var senses = [37,38,39,40];
        if (isChoosingSens &&  senses.indexOf(typedKey) !== -1) {
            // chosing sens
            console.log('current Mode : sens chosen!');
            currentModeText.innerHTML = 'choosing sens';
            sens = typedKey;
            isChoosingSens = false;
            console.log("sens is " + sens);
        } else if(isNavigating() && senses.indexOf(typedKey) !== -1) {
            // navigating
            console.log('current Mode : navigating');
            currentModeText.innerHTML = 'navigating';
            var x = document.activeElement.getAttribute('data-x');
            var y = document.activeElement.getAttribute('data-y');
            var newX = typedKey === 37 ? +x-1 : typedKey === 39 ? +x+1 : +x;
            var newY = typedKey === 38 ? +y-1 : typedKey === 40 ? +y+1 : +y;
            var next = document.querySelector('.inputGrid[data-x="'+newX+'"][data-y="'+newY+'"]');
            if(next) next.focus();
        } else if (isTypingWord() && typedKey === 13) {
            console.log('current Mode : validate word');
            currentModeText.innerHTML = 'word validated';
            // validate a word
            validWord();
            sens = void 0;
            current.word = '';
        } else if (isTypingWord()){
            console.log('current Mode : typing word');
            currentModeText.innerHTML = 'typing a word';
            // type a letter
            current.word += typedKey;
            goToNextCase();
        } else if(isNavigating() && typedKey === 13) {
            console.log('current Mode : choosing sens');
            currentModeText.innerHTML = 'choosing sens';
            isChoosingSens = true;
        } else {
            // nothing from above
            currentModeText.innerHTML = 'nothing';
            console.log('nope');
        }
    };

    var dynamicEvents = function dynamicEvents() {
        var inputs = document.getElementsByClassName('inputGrid');
        var inputsLength = inputs.length;
        for (var i = 0; i < inputsLength; i++) {
            var input = inputs[i];
//            input.removeEventListener("focus",gridFocus);
            input.removeEventListener("keydown",gridKeydown);

//            input.addEventListener("focus", gridFocus.bind(this), false);
            input.addEventListener("keydown", gridKeydown.bind(this), false);
        }
    };

</script>
</html>